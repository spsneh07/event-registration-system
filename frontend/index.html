<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Event Attendance & Registration — Admin</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <!-- QR & XLSX libs -->
  <script src="https://unpkg.com/html5-qrcode/html5-qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    body { font-family: 'Inter', sans-serif; background-color: #0b1220; }
    #reader { border-radius: .5rem; overflow: hidden; width: 100%; max-width: 420px; height: 320px; }
    #reader video { width: 100% !important; height: auto !important; }
    .glowing-border { box-shadow: 0 0 5px rgba(59,130,246,.5), 0 0 10px rgba(59,130,246,.3); }
    button:disabled { opacity: .5; cursor: not-allowed; }
  </style>
</head>
<body class="text-gray-200">
  <div class="min-h-screen p-6 max-w-6xl mx-auto">
    <header class="mb-6 text-center">
      <h1 class="text-3xl font-bold">EventSphere — Admin</h1>
      <p class="text-gray-400 mt-1">Live Attendance & QR Scanner</p>
    </header>

    <!-- Live stats -->
    <section class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
      <div class="bg-gray-800 p-6 rounded-lg shadow">
        <div class="text-sm text-gray-400">Total Registered</div>
        <div id="stat-total" class="text-3xl font-bold text-white mt-2">0</div>
      </div>
      <div class="bg-gray-800 p-6 rounded-lg shadow">
        <div class="text-sm text-gray-400">Checked In</div>
        <div id="stat-checked" class="text-3xl font-bold text-green-400 mt-2">0</div>
      </div>
      <div class="bg-gray-800 p-6 rounded-lg shadow">
        <div class="text-sm text-gray-400">Attendance Rate</div>
        <div id="stat-rate" class="text-3xl font-bold text-blue-400 mt-2">0%</div>
      </div>
    </section>

    <main class="space-y-6">
      <!-- Scanner card -->
      <section class="bg-gray-800 p-6 rounded-lg shadow">
        <div class="flex items-start justify-between">
          <div>
            <h2 class="text-xl font-semibold">QR Code Scanner</h2>
            <p class="text-sm text-gray-400">Use the front camera to scan attendee QR codes and check them in.</p>
          </div>

          <div class="flex items-center gap-3">
            <input id="admin-api-key" placeholder="Admin API Key (optional)" class="bg-gray-700 text-white px-3 py-2 rounded" />
            <button id="btn-start" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded text-white">Start Camera</button>
            <button id="btn-stop" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded text-white" disabled>Stop</button>
          </div>
        </div>

        <div class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-4">
          <div class="bg-gray-900 p-4 rounded glowing-border">
            <div id="reader" class="mx-auto"></div>
            <div id="scan-status" class="mt-2 text-sm text-gray-300">Scanner idle</div>
            <div id="last-scanned" class="mt-1 text-sm text-green-300"></div>
          </div>

          <div class="bg-gray-900 p-4 rounded">
            <div class="text-sm text-gray-400">Scan Result</div>
            <pre id="scan-output" class="bg-gray-800 rounded p-3 text-sm mt-2 break-words" style="min-height:120px;">No QR scanned yet.</pre>
            <div class="mt-4 flex gap-2">
              <button id="manual-refresh" class="px-3 py-1 bg-gray-700 rounded text-white">Refresh List</button>
              <button id="export-btn" class="px-3 py-1 bg-blue-600 rounded text-white">Export to Excel</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Attendance list -->
      <section class="bg-gray-800 p-6 rounded-lg shadow">
        <h3 class="text-lg font-semibold mb-4">Attendance List</h3>
        <div id="error-msg" class="text-red-400 mb-4 hidden"></div>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm text-left text-gray-300">
            <thead class="bg-gray-700 text-gray-200">
              <tr>
                <th class="px-4 py-2">Name</th>
                <th class="px-4 py-2">Email</th>
                <th class="px-4 py-2">Status</th>
                <th class="px-4 py-2">Check-in Time</th>
                <th class="px-4 py-2">Action</th>
              </tr>
            </thead>
            <tbody id="participants-table" class="divide-y divide-gray-600">
              <tr><td colspan="5" class="px-4 py-6 text-center text-gray-400">No data loaded.</td></tr>
            </tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

<script>
(() => {
  // CONFIG: change if needed
  const API_BASE_URL = 'https://event-registration-system-azym.onrender.com';

  // UI refs
  const btnStart = document.getElementById('btn-start');
  const btnStop = document.getElementById('btn-stop');
  const readerEl = document.getElementById('reader');
  const scanStatus = document.getElementById('scan-status');
  const scanOutput = document.getElementById('scan-output');
  const lastScanned = document.getElementById('last-scanned');
  const participantsTable = document.getElementById('participants-table');
  const errorMsg = document.getElementById('error-msg');
  const statTotal = document.getElementById('stat-total');
  const statChecked = document.getElementById('stat-checked');
  const statRate = document.getElementById('stat-rate');
  const manualRefresh = document.getElementById('manual-refresh');
  const exportBtn = document.getElementById('export-btn');
  const apiKeyInput = document.getElementById('admin-api-key');

  // state
  let html5QrCode = null;
  let scanning = false;
  let participantsCache = [];
  let lastScanTime = 0;

  // persist admin key in sessionStorage for convenience
  apiKeyInput.value = sessionStorage.getItem('es_admin_key') || '';
  apiKeyInput.addEventListener('change', () => {
    sessionStorage.setItem('es_admin_key', apiKeyInput.value.trim());
  });

  // helper: get header with optional API key (x-api-key)
  function getAuthHeaders() {
    const headers = { 'Content-Type': 'application/json' };
    const key = sessionStorage.getItem('es_admin_key') || '';
    if (key) headers['x-api-key'] = key;
    return headers;
  }

  // Start scanner
  btnStart.addEventListener('click', async () => {
    if (scanning) return;
    scanStatus.textContent = 'Requesting camera permission...';
    btnStart.disabled = true;

    try {
      if (!Html5Qrcode) throw new Error('html5-qrcode library not loaded');

      html5QrCode = new Html5Qrcode(/* element id */ "reader");

      const config = { fps: 10, qrbox: { width: 300, height: 300 }, experimentalFeatures: { useBarCodeDetectorIfSupported: false } };

      // start with front camera
      await html5QrCode.start(
        { facingMode: "user" }, 
        config,
        (decodedText, decodedResult) => {
          const now = Date.now();
          // simple debounce to avoid multiple rapid triggers
          if (now - lastScanTime < 1200) return;
          lastScanTime = now;
          onScanSuccess(decodedText);
        },
        (errorMessage) => {
          // scanning in progress; could show or ignore
          // console.debug('scan error', errorMessage);
        }
      );

      scanning = true;
      scanStatus.textContent = 'Scanning... (front camera)';
      btnStop.disabled = false;
    } catch (err) {
      console.error('Scanner start failed', err);
      scanStatus.textContent = 'Failed to start camera: ' + (err.message || err);
      btnStart.disabled = false;
    }
  });

  // Stop scanner
  btnStop.addEventListener('click', async () => {
    if (!scanning || !html5QrCode) return;
    try {
      await html5QrCode.stop();
      await html5QrCode.clear();
    } catch (err) {
      console.warn('Error stopping scanner', err);
    } finally {
      scanning = false;
      html5QrCode = null;
      scanStatus.textContent = 'Scanner stopped';
      btnStart.disabled = false;
      btnStop.disabled = true;
    }
  });

  // Called when a QR is decoded
  async function onScanSuccess(decodedText) {
    scanOutput.textContent = decodedText;
    lastScanned.textContent = `Last scanned at ${new Date().toLocaleTimeString()}`;
    // Attempt to call checkin endpoint (use API key if provided)
    try {
      const headers = getAuthHeaders();
      const resp = await fetch(`${API_BASE_URL}/checkin/${encodeURIComponent(decodedText)}`, {
        method: 'POST',
        headers
      });

      // parse JSON safely
      const data = await safeParseJson(resp);
      if (!resp.ok) {
        const msg = data && data.error ? data.error : (data._rawText || 'Check-in failed');
        showTransientMessage(`❌ ${msg}`, true);
      } else {
        showTransientMessage(`✅ ${data.message || 'Checked in'}`, false);
        // refresh participants list
        await fetchParticipants();
      }
    } catch (err) {
      console.error('Check-in error', err);
      showTransientMessage('❌ Check-in request failed (network or server).', true);
    }
  }

  // small transient notification in scan status
  function showTransientMessage(msg, isError = false) {
    scanStatus.textContent = msg;
    scanStatus.style.color = isError ? '#f87171' : '#86efac';
    setTimeout(() => {
      scanStatus.textContent = scanning ? 'Scanning... (front camera)' : 'Scanner idle';
      scanStatus.style.color = '';
    }, 3000);
  }

  // safe JSON parsing fallback
  async function safeParseJson(response) {
    const text = await response.text();
    try { return JSON.parse(text); }
    catch { return { _rawText: text }; }
  }

  // fetch participants and render table/stats
  async function fetchParticipants() {
    errorMsg.classList.add('hidden');
    participantsTable.innerHTML = `<tr><td colspan="5" class="px-4 py-6 text-center text-gray-400">Loading...</td></tr>`;
    try {
      const resp = await fetch(`${API_BASE_URL}/participants`, { headers: getAuthHeaders() });
      const data = await safeParseJson(resp);
      if (!resp.ok) {
        const msg = data && data.error ? data.error : (data._rawText || 'Failed to fetch participants');
        throw new Error(msg);
      }

      participantsCache = Array.isArray(data) ? data : [];
      renderParticipants(participantsCache);
      updateStats(participantsCache);
    } catch (err) {
      console.error('Fetch participants error', err);
      participantsTable.innerHTML = `<tr><td colspan="5" class="px-4 py-6 text-center text-red-400">Error: Could not load data. Is the backend server running?</td></tr>`;
      errorMsg.textContent = String(err.message || err);
      errorMsg.classList.remove('hidden');
      statTotal.textContent = '—';
      statChecked.textContent = '—';
      statRate.textContent = '—';
    }
  }

  function renderParticipants(list) {
    participantsTable.innerHTML = '';
    if (!list || list.length === 0) {
      participantsTable.innerHTML = `<tr><td colspan="5" class="px-4 py-6 text-center text-gray-400">No participants yet.</td></tr>`;
      return;
    }

    list.forEach(p => {
      const tr = document.createElement('tr');

      const tdName = document.createElement('td');
      tdName.className = 'px-4 py-2';
      tdName.textContent = p.name || '-';
      tr.appendChild(tdName);

      const tdEmail = document.createElement('td');
      tdEmail.className = 'px-4 py-2';
      tdEmail.textContent = p.email || '-';
      tr.appendChild(tdEmail);

      const tdStatus = document.createElement('td');
      tdStatus.className = 'px-4 py-2';
      tdStatus.textContent = p.attended ? '✅ Checked In' : '❌ Not Checked';
      tr.appendChild(tdStatus);

      const tdTime = document.createElement('td');
      tdTime.className = 'px-4 py-2';
      tdTime.textContent = p.timestamp ? new Date(p.timestamp).toLocaleString() : '-';
      tr.appendChild(tdTime);

      const tdAction = document.createElement('td');
      tdAction.className = 'px-4 py-2';
      if (p.attended) {
        const span = document.createElement('span');
        span.className = 'text-green-400';
        span.textContent = 'Checked';
        tdAction.appendChild(span);
      } else {
        const btn = document.createElement('button');
        btn.className = 'bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded';
        btn.textContent = 'Check In';
        btn.addEventListener('click', () => manualCheckIn(p.registration_id));
        tdAction.appendChild(btn);
      }
      tr.appendChild(tdAction);

      participantsTable.appendChild(tr);
    });
  }

  // manual check-in button click
  async function manualCheckIn(regId) {
    try {
      const resp = await fetch(`${API_BASE_URL}/checkin/${encodeURIComponent(regId)}`, { method: 'POST', headers: getAuthHeaders() });
      const data = await safeParseJson(resp);
      if (!resp.ok) {
        alert(data && data.error ? data.error : (data._rawText || 'Check-in failed'));
      } else {
        alert(data.message || 'Checked in');
        await fetchParticipants();
      }
    } catch (err) {
      console.error(err);
      alert('Check-in request failed');
    }
  }

  function updateStats(list) {
    const total = list.length;
    const checked = list.filter(x => x.attended).length;
    const rate = total === 0 ? 0 : Math.round((checked / total) * 100);
    statTotal.textContent = total;
    statChecked.textContent = checked;
    statRate.textContent = `${rate}%`;
  }

  // Export XLSX
  exportBtn.addEventListener('click', () => {
    if (!participantsCache || participantsCache.length === 0) return alert('No participants to export.');
    const sheetData = participantsCache.map(p => ({
      Name: p.name || '',
      Email: p.email || '',
      RegistrationID: p.registration_id || '',
      CheckedIn: p.attended ? 'Yes' : 'No',
      Timestamp: p.timestamp ? new Date(p.timestamp).toLocaleString() : ''
    }));
    const ws = XLSX.utils.json_to_sheet(sheetData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Participants');
    XLSX.writeFile(wb, 'participants.xlsx');
  });

  // manual refresh
  manualRefresh.addEventListener('click', fetchParticipants);

  // initial load
  fetchParticipants();

  // clean up on tab close
  window.addEventListener('beforeunload', async () => {
    if (scanning && html5QrCode) {
      try { await html5QrCode.stop(); await html5QrCode.clear(); } catch (e) {}
    }
  });
})();
</script>
</body>
</html>
